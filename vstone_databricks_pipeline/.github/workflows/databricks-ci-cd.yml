name: Databricks Project CI/CD

on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - dev

jobs:
  deploy_and_test:
    name: "Deploy and Test Pipeline"
    runs-on: ubuntu-latest

    # Set common environment variables for all steps to avoid repetition
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      # 1. Check out the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Install Databricks CLI (Using the official setup action for reliability)
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main

      # 3. Validate the Asset Bundle (Infrastructure Check)
      - name: Validate Bundle
        run: databricks bundle validate -t dev

      # 4. Conditional Deployment (Only deploys if the push is to the 'dev' branch)
      - name: Deploy Bundle to Dev
        if: github.ref == 'refs/heads/dev'
        run: databricks bundle deploy -t dev

      # 5. Run Automated Test Orchestrator
      # This calls your 'Master Runner' which executes all 6 test notebooks
      - name: Run Automated Test Job
        run: databricks bundle run vstone_test_runner